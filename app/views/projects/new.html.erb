<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スケジュール作成ページ</title>
    <script>
        const defaultLeadTimes = {
            productionToShipment: 14,
            materialDeliveryToProduction: 14,
            materialOrderToMaterialDelivery: 100,
            orderReceiptToMaterialOrder: 5,
            containerTestEndToOrderReceipt: 5,
            containerTestStartToContainerTestEnd: 40,
            containerTestRequestToContainerTestStart: 15,
            formulationDecisionToContainerTestRequest: 3,
            containerDecisionToContainerTestRequest: 10
        };

        let leadTimes = { ...defaultLeadTimes };

        // 祝日リスト自動生成（日本の祝日）
        function getHolidays(year) {
            const holidays = [];

            // 固定の日付
            holidays.push(new Date(year, 0, 1));  // 元日 (1月1日)
            holidays.push(new Date(year, 1, 11)); // 建国記念の日 (2月11日)
            holidays.push(new Date(year, 3, 29)); // 昭和の日 (4月29日)
            holidays.push(new Date(year, 4, 3));  // 憲法記念日 (5月3日)
            holidays.push(new Date(year, 4, 4));  // みどりの日 (5月4日)
            holidays.push(new Date(year, 4, 5));  // こどもの日 (5月5日)
            holidays.push(new Date(year, 10, 3)); // 文化の日 (11月3日)
            holidays.push(new Date(year, 10, 23)); // 勤労感謝の日 (11月23日)
            holidays.push(new Date(year, 1, 23)); // 天皇誕生日 (2月23日)

            // 春分の日と秋分の日は年ごとに変動
            holidays.push(getVernalEquinoxDay(year));  // 春分の日
            holidays.push(getAutumnalEquinoxDay(year)); // 秋分の日

            // 第2月曜日や第3月曜日など
            holidays.push(getNthWeekdayOfMonth(2, 1, 0, year)); // 成人の日 (1月第2月曜日)
            holidays.push(getNthWeekdayOfMonth(3, 1, 6, year)); // 海の日 (7月第3月曜日)
            holidays.push(getNthWeekdayOfMonth(3, 1, 8, year)); // 敬老の日 (9月第3月曜日)
            holidays.push(getNthWeekdayOfMonth(2, 1, 9, year)); // 体育の日 (10月第2月曜日)

            return holidays;
        }

        // 第n月曜日を取得
        function getNthWeekdayOfMonth(n, weekday, month, year) {
            let date = new Date(year, month, 1);
            let count = 0;
            while (count < n) {
                if (date.getDay() === weekday) {
                    count++;
                }
                if (count < n) {
                    date.setDate(date.getDate() + 1);
                }
            }
            return date;
        }

        // 春分の日を取得
        function getVernalEquinoxDay(year) {
            let day;
            if (year <= 1979) {
                day = Math.floor(20.8357 + 0.242194 * (year - 1980)) - Math.floor((year - 1983) / 4);
            } else if (year <= 2099) {
                day = Math.floor(20.8431 + 0.242194 * (year - 1980)) - Math.floor((year - 1980) / 4);
            } else {
                day = Math.floor(21.8510 + 0.242194 * (year - 1980)) - Math.floor((year - 1980) / 4);
            }
            return new Date(year, 2, day); // 3月
        }

        // 秋分の日を取得
        function getAutumnalEquinoxDay(year) {
            let day;
            if (year <= 1979) {
                day = Math.floor(23.2588 + 0.242194 * (year - 1980)) - Math.floor((year - 1983) / 4);
            } else if (year <= 2099) {
                day = Math.floor(23.2488 + 0.242194 * (year - 1980)) - Math.floor((year - 1980) / 4);
            } else {
                day = Math.floor(24.2488 + 0.242194 * (year - 1980)) - Math.floor((year - 1980) / 4);
            }
            return new Date(year, 8, day); // 9月
        }

        // 祝日や土日を除外する関数
        function skipWeekendsAndHolidays(date, holidays) {
            while (isWeekendOrHoliday(date, holidays)) {
                date.setDate(date.getDate() + 1); // 翌営業日に繰り越す
            }
            return date;
        }

        // 土日または祝日かどうかを判定する
        function isWeekendOrHoliday(date, holidays) {
            const day = date.getDay();
            const isWeekend = (day === 0 || day === 6); // 0は日曜日、6は土曜日
            const isHoliday = holidays.some(holiday => holiday.getTime() === date.getTime());
            return isWeekend || isHoliday;
        }

        // スケジュール計算
        function calculateSchedule() {
            const year = new Date().getFullYear();
            const holidays = getHolidays(year);

            let shipmentDateValue = document.getElementById("shipmentDate").value;
            if (!shipmentDateValue) {
                alert("出荷日を入力してください。");
                return;
            }

            let shipmentDate = new Date(shipmentDateValue);
            shipmentDate = skipWeekendsAndHolidays(shipmentDate, holidays); // 出荷日を確認

            let productionDate = new Date(shipmentDate);
            productionDate.setDate(productionDate.getDate() - leadTimes.productionToShipment);
            productionDate = skipWeekendsAndHolidays(productionDate, holidays); // 生産日を確認

            let materialDeliveryDate = new Date(productionDate);
            materialDeliveryDate.setDate(materialDeliveryDate.getDate() - leadTimes.materialDeliveryToProduction);
            materialDeliveryDate = skipWeekendsAndHolidays(materialDeliveryDate, holidays); // 資材納品日を確認

            let materialOrderDate = new Date(materialDeliveryDate);
            materialOrderDate.setDate(materialOrderDate.getDate() - leadTimes.materialOrderToMaterialDelivery);
            materialOrderDate = skipWeekendsAndHolidays(materialOrderDate, holidays); // 資材発注日を確認

            let orderReceiptDate = new Date(materialOrderDate);
            orderReceiptDate.setDate(orderReceiptDate.getDate() - leadTimes.orderReceiptToMaterialOrder);
            orderReceiptDate = skipWeekendsAndHolidays(orderReceiptDate, holidays); // 注文書受領日を確認

            let containerTestEndDate = new Date(orderReceiptDate);
            containerTestEndDate.setDate(containerTestEndDate.getDate() - leadTimes.containerTestEndToOrderReceipt);
            containerTestEndDate = skipWeekendsAndHolidays(containerTestEndDate, holidays); // 容器試験終了日を確認

            let containerTestStartDate = new Date(containerTestEndDate);
            containerTestStartDate.setDate(containerTestStartDate.getDate() - leadTimes.containerTestStartToContainerTestEnd);
            containerTestStartDate = skipWeekendsAndHolidays(containerTestStartDate, holidays); // 容器試験スタート日を確認

            let containerTestRequestDate = new Date(containerTestStartDate);
            containerTestRequestDate.setDate(containerTestRequestDate.getDate() - leadTimes.containerTestRequestToContainerTestStart);
            containerTestRequestDate = skipWeekendsAndHolidays(containerTestRequestDate, holidays); // 容器試験依頼日を確認

            let formulationDecisionDate = new Date(containerTestRequestDate);
            formulationDecisionDate.setDate(formulationDecisionDate.getDate() - leadTimes.formulationDecisionToContainerTestRequest);
            formulationDecisionDate = skipWeekendsAndHolidays(formulationDecisionDate, holidays); // 処方決定日を確認

            let containerDecisionDate = new Date(containerTestRequestDate);
            containerDecisionDate.setDate(containerDecisionDate.getDate() - leadTimes.containerDecisionToContainerTestRequest);
            containerDecisionDate = skipWeekendsAndHolidays(containerDecisionDate, holidays); // 容器決定日を確認

            let category = document.getElementById("category").value;
            let containerTestEndLabel = category === "1" ? "容器試験終了（化粧品）" : "容器試験終了（医薬部外品）";

            // 各タスクの日程を設定
            setTaskRow("containerDecisionDate", containerDecisionDate, "容器決定");
            setTaskRow("formulationDecisionDate", formulationDecisionDate, "処方決定");
            setTaskRow("containerTestRequestDate", containerTestRequestDate, "容器試験依頼");
            setTaskRow("containerTestStartDate", containerTestStartDate, "容器試験スタート");
            setTaskRow("containerTestEndDate", containerTestEndDate, containerTestEndLabel);
            setTaskRow("orderReceiptDate", orderReceiptDate, "注文書受領");
            setTaskRow("materialOrderDate", materialOrderDate, "資材発注");
            setTaskRow("materialDeliveryDate", materialDeliveryDate, "資材納品");
            setTaskRow("productionDate", productionDate, "生産");
        }

        function setTaskRow(taskId, taskDate, taskName) {
            let taskRow = document.getElementById(taskId);
            taskRow.querySelector(".task-date").value = taskDate.toLocaleDateString();
            taskRow.querySelector(".task-name").textContent = taskName;
        }

        function toggleTaskEdit(checkbox, taskId) {
            let taskDateField = document.getElementById(taskId).querySelector(".task-date");
            taskDateField.disabled = !checkbox.checked;
        }

        function updateLeadTime() {
            leadTimes.productionToShipment = parseInt(document.getElementById("productionToShipment").value);
            leadTimes.materialDeliveryToProduction = parseInt(document.getElementById("materialDeliveryToProduction").value);
            leadTimes.materialOrderToMaterialDelivery = parseInt(document.getElementById("materialOrderToMaterialDelivery").value);
            leadTimes.orderReceiptToMaterialOrder = parseInt(document.getElementById("orderReceiptToMaterialOrder").value);
            leadTimes.containerTestEndToOrderReceipt = parseInt(document.getElementById("containerTestEndToOrderReceipt").value);
            leadTimes.containerTestStartToContainerTestEnd = parseInt(document.getElementById("containerTestStartToContainerTestEnd").value);
            leadTimes.containerTestRequestToContainerTestStart = parseInt(document.getElementById("containerTestRequestToContainerTestStart").value);
            leadTimes.formulationDecisionToContainerTestRequest = parseInt(document.getElementById("formulationDecisionToContainerTestRequest").value);
            leadTimes.containerDecisionToContainerTestRequest = parseInt(document.getElementById("containerDecisionToContainerTestRequest").value);
        }

        function toggleLeadTimeEdit() {
            let leadTimeSection = document.getElementById("leadTimeSection");
            if (leadTimeSection.style.display === "none") {
                leadTimeSection.style.display = "block";
            } else {
                leadTimeSection.style.display = "none";
            }
        }

        window.onload = function() {
            document.getElementById("leadTimeSection").style.display = "none"; // 初期は非表示
        };
    </script>
</head>
<body>
    <h1>スケジュール作成ページ</h1>

    <form>
        <label for="customerName">顧客名: </label>
        <input type="text" id="customerName" name="customerName" required>
        <br><br>

        <label for="productName">商品名: </label>
        <input type="text" id="productName" name="productName" required>
        <br><br>

        <label for="productVolume">容量: </label>
        <input type="text" id="productVolume" name="productVolume" required>
        <br><br>

        <label for="category">区分を選択してください: </label>
        <select id="category">
            <option value="1">化粧品</option>
            <option value="2">医薬部外品</option>
        </select>

        <br><br>

        <label for="shipmentDate">出荷日を入力してください: </label>
        <input type="date" id="shipmentDate">
        <button type="button" onclick="calculateSchedule()">AUTO</button>

        <br><br>

        <table>
            <tr id="containerDecisionDate">
                <td><input type="checkbox" onchange="toggleTaskEdit(this, 'containerDecisionDate')"></td>
                <td><input type="text" class="task-date" disabled></td>
                <td class="task-name">容器決定</td>
            </tr>
            <tr id="formulationDecisionDate">
                <td><input type="checkbox" onchange="toggleTaskEdit(this, 'formulationDecisionDate')"></td>
                <td><input type="text" class="task-date" disabled></td>
                <td class="task-name">処方決定</td>
            </tr>
            <tr id="containerTestRequestDate">
                <td><input type="checkbox" onchange="toggleTaskEdit(this, 'containerTestRequestDate')"></td>
                <td><input type="text" class="task-date" disabled></td>
                <td class="task-name">容器試験依頼</td>
            </tr>
            <tr id="containerTestStartDate">
                <td><input type="checkbox" onchange="toggleTaskEdit(this, 'containerTestStartDate')"></td>
                <td><input type="text" class="task-date" disabled></td>
                <td class="task-name">容器試験スタート</td>
            </tr>
            <tr id="containerTestEndDate">
                <td><input type="checkbox" onchange="toggleTaskEdit(this, 'containerTestEndDate')"></td>
                <td><input type="text" class="task-date" disabled></td>
                <td class="task-name">容器試験終了（化粧品/医薬部外品）</td>
            </tr>
            <tr id="orderReceiptDate">
                <td><input type="checkbox" onchange="toggleTaskEdit(this, 'orderReceiptDate')"></td>
                <td><input type="text" class="task-date" disabled></td>
                <td class="task-name">注文書受領</td>
            </tr>
            <tr id="materialOrderDate">
                <td><input type="checkbox" onchange="toggleTaskEdit(this, 'materialOrderDate')"></td>
                <td><input type="text" class="task-date" disabled></td>
                <td class="task-name">資材発注</td>
            </tr>
            <tr id="materialDeliveryDate">
                <td><input type="checkbox" onchange="toggleTaskEdit(this, 'materialDeliveryDate')"></td>
                <td><input type="text" class="task-date" disabled></td>
                <td class="task-name">資材納品</td>
            </tr>
            <tr id="productionDate">
                <td><input type="checkbox" onchange="toggleTaskEdit(this, 'productionDate')"></td>
                <td><input type="text" class="task-date" disabled></td>
                <td class="task-name">生産</td>
            </tr>
        </table>
    </form>

    <br><br>

    <button type="button" onclick="toggleLeadTimeEdit()">リードタイム編集</button>

    <div id="leadTimeSection">
        <h2>リードタイムを編集:</h2>
        <label for="productionToShipment">生産から出荷までの日数: </label>
        <input type="number" id="productionToShipment" value="14">
        <br>
        <label for="materialDeliveryToProduction">資材納品から生産までの日数: </label>
        <input type="number" id="materialDeliveryToProduction" value="14">
        <br>
        <label for="materialOrderToMaterialDelivery">資材発注から資材納品までの日数: </label>
        <input type="number" id="materialOrderToMaterialDelivery" value="100">
        <br>
        <label for="orderReceiptToMaterialOrder">注文書受領から資材発注までの日数: </label>
        <input type="number" id="orderReceiptToMaterialOrder" value="5">
        <br>
        <label for="containerTestEndToOrderReceipt">容器試験終了から注文書受領までの日数: </label>
        <input type="number" id="containerTestEndToOrderReceipt" value="5">
        <br>
        <label for="containerTestStartToContainerTestEnd">容器試験スタートから終了までの日数: </label>
        <input type="number" id="containerTestStartToContainerTestEnd" value="40">
        <br>
        <label for="containerTestRequestToContainerTestStart">容器試験依頼からスタートまでの日数: </label>
        <input type="number" id="containerTestRequestToContainerTestStart" value="15">
        <br>
        <label for="formulationDecisionToContainerTestRequest">処方決定から容器試験依頼までの日数: </label>
        <input type="number" id="formulationDecisionToContainerTestRequest" value="3">
        <br>
        <label for="containerDecisionToContainerTestRequest">容器決定から容器試験依頼までの日数: </label>
        <input type="number" id="containerDecisionToContainerTestRequest" value="10">
        <br><br>

        <button onclick="updateLeadTime()">リードタイムを更新</button>
    </div>
</body>
</html>
